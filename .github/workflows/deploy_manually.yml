name: Deploy branch manually
on:
  workflow_dispatch:
    inputs:
      devopsBranch:
        description: 'Devops branch with configs. see https://github.com/MikronMIK32/devops'
        required: true

jobs:
  deploy:
    runs-on: [self-hosted, prod]
    steps:
      - name: Set env.BRANCH
        run: echo "BRANCH=$(echo $GITHUB_REF | cut -d'/' -f 3)" >> $GITHUB_ENV
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.ref }}

      - name: Load devops archive
        run: |
          mkdir devops-extracted
          chmod +w devops-extracted
          curl -fvSL --header "Authorization: Bearer ${{ secrets.PAT_TOKEN }}" https://api.github.com/repos/MikronMIK32/devops/tarball/ -o "devops-extracted/archive.tar.gz"
      - name: Concat env
        run: |
          tar -xzf ./devops-extracted/archive.tar.gz -C devops-extracted/ --strip-components=1
          rm ./devops-extracted/archive.tar.gz
          cp -r devops-extracted/common/* ./
          cp -r devops-extracted/apps/configurator/front/* ./
          echo "" > newline.txt
          cat devops-extracted/common/.env newline.txt devops-extracted/apps/configurator/front/.env > .env
          rm -rf ./devops-extracted
      - name: Create image
        env:
          REF: ${{ github.ref }}
          COMMIT_ID: ${{ github.sha }}
        run: |
          echo "TODO: create docker image build! Branch name is ${{ env.BRANCH }}, sha is $COMMIT_ID"